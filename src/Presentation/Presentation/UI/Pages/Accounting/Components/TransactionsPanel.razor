@rendermode InteractiveServer
@using System.Globalization

<MudStack Spacing="2">
    <MudText Typo="Typo.h5">Транзакции</MudText>

    <MudTextField @bind-Value="_search"
                  Placeholder="Поиск (название, кошелёк, категория, контрагент)…"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Clearable="true"
                  Immediate="true"
                  EditMode="DataGridEditMode.Form"
                  Style="max-width:420px" />

    <MudDataGrid T="Transaction"
                 Items="@Filtered"
                 Filterable="true"
                 Groupable="true"
                 FilterMode="@DataGridFilterMode.Simple"
                 Hover="true" Dense="false" Striped="true" Bordered="true"
                 RowsPerPage="10">

        <Columns>
            <PropertyColumn Property="x => x.Date" Title="Дата" Format="dd.MM.yyyy" />
            <PropertyColumn Property="x => x.WalletName" Title="Кошелёк"/>
            <PropertyColumn Property="x => x.TransactionType" Title="ТипТранзакции"/>
            <PropertyColumn Property="x => x.Category" Title="Категория"/>
            <PropertyColumn Property="x => x.Counterparty" Title="Контрагент"/>
            <PropertyColumn Property="x => x.Amount" Title="Сумма" AggregateDefinition="_amountAggregation"/>
            <PropertyColumn Property="x => x.Note" Title="Коментарий"/>

            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync"/>
                </CellTemplate>
            </TemplateColumn>
        </Columns>

        <PagerContent>
            <MudDataGridPager T="Transaction" PageSizeOptions="new int[]{5,10,20}" />
        </PagerContent>
    </MudDataGrid>
</MudStack>

@code {
    private string? _search;

    public sealed record Transaction(
        DateOnly Date,
        string WalletName,
        string TransactionType,
        string Category,
        string Counterparty,
        decimal Amount,
        string Note = "");

    // Демо данные
   private readonly List<Transaction> _all =
[
    new(new(2025,9,1),  "Монобанк", "Расход", "Закупки",      "Сырьё",          -12500.0m, "Закупка ткани саржа"),
    new(new(2025,9,2),  "Приват",   "Доход",  "Продажи",      "B2B",              18990.0m, "Продажа комплектов 'Антей'"),
    new(new(2025,9,3),  "Приват",   "Расход", "Налоги",       "ЕН",               -4200.0m, "Налоги ЕН"),
    new(new(2025,9,3),  "Касса",    "Расход", "Логистика",    "Нова Пошта",        -890.0m, "Доставка НП"),
    new(new(2025,9,4),  "Касса",    "Расход", "ФОТ",          "Аванс",           -16000.0m, "Аванс швеям"),
    new(new(2025,9,5),  "Ощад",     "Расход", "Закупки",      "Сырьё",            -7400.0m, "Оплата ткани 'электрик'"),
    new(new(2025,9,6),  "Монобанк", "Доход",  "Продажи",      "Розница",           2450.0m, "Продажа 'Сварог' штаны"),
    new(new(2025,9,6),  "Приват",   "Расход", "Маркетинг",    "Google Ads",       -3100.0m, "Реклама Google Ads"),
    new(new(2025,9,7),  "Приват",   "Доход",  "Продажи",      "B2B",              32500.0m, "Поступление Brevi B2B"),
    new(new(2025,9,7),  "Ощад",     "Расход", "Операционные", "Коммуналка",       -2100.96m,"Коммуналка цех"),
    new(new(2025,9,8),  "Монобанк", "Расход", "Закупки",      "Фурнитура",        -1900.0m, "Фурнитура"),
    new(new(2025,9,8),  "Приват",   "Доход",  "Прочее",       "Возвраты",          1450.8m, "Возврат от клиента"),
    new(new(2025,9,9),  "Приват",   "Доход",  "Продажи",      "B2B",              27900.0m, "Продажа 'Заметіль' комплект"),
    new(new(2025,9,9),  "Приват",   "Расход", "IT",           "Инфраструктура",    -650.0m, "Хостинг/VPS"),
    new(new(2025,9,10), "Касса",    "Расход", "ФОТ",          "Зарплата",        -22000.0m, "Зарплата швеям"),
    new(new(2025,9,11), "Ощад",     "Расход", "Услуги",       "Вышивка",          -1200.0m, "Вышивка логотипов"),
    new(new(2025,9,12), "Монобанк", "Доход",  "Продажи",      "Розница",           3560.6m, "Продажа жилетов 'Гриф'"),
    new(new(2025,9,12), "Касса",    "Расход", "Операционные", "Расходники",        -480.7m, "Масло для машин"),
    new(new(2025,9,13), "Приват",   "Расход", "Маркетинг",    "SEO",              -5000.0m, "SEO подрядчик"),
    new(new(2025,9,14), "Приват",   "Доход",  "Продажи",      "B2B",               9150.4m, "Полукомбинезон 'Влес'"),
    new(new(2025,9,14), "Касса",    "Расход", "Операционные", "Бытовые",           -350.0m, "Кофе в офис"),
    new(new(2025,9,15), "Ощад",     "Расход", "Закупки",      "Сырьё",            -9800.0m, "Ткань 'графит'"),
    new(new(2025,9,16), "Монобанк", "Доход",  "Продажи",      "Розница",           3990.11m,"Костюм 'Антей'"),
    new(new(2025,9,16), "Приват",   "Расход", "Операционные", "Связь",             -720.5m, "Интернет/связь"),
];


    private IEnumerable<Transaction> Filtered =>
        string.IsNullOrWhiteSpace(_search)
            ? _all
            : _all.Where(t =>
                (!string.IsNullOrEmpty(t.Note) && t.Note.Contains(_search, StringComparison.OrdinalIgnoreCase))
                || t.WalletName.Contains(_search, StringComparison.OrdinalIgnoreCase)
                || t.TransactionType.Contains(_search, StringComparison.OrdinalIgnoreCase)
                || t.Category.Contains(_search, StringComparison.OrdinalIgnoreCase)
                || t.Counterparty.Contains(_search, StringComparison.OrdinalIgnoreCase));

    AggregateDefinition<Transaction> _amountAggregation = new AggregateDefinition<Transaction>
    {
        Type = AggregateType.Sum,
        DisplayFormat = "Всього {value}"
    };


}
